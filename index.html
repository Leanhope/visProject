<!--
VISUALIZATION FINAL PROJECT
///////////////////////////
FREDERIK SUKOP, 114723
HANS LIENHOP, 114926
///////////////////////////
BAUHAUS UNIVERSITÃ„T WEIMAR
FACULTY OF MEDIA
 -->

<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type"></meta>
  <meta content="utf-8" http-equiv="encoding"></meta>
  <title>Last.fm Visualization</title>
  <link rel="stylesheet" href="jquery-jvectormap-2.0.3.css" type="text/css" media="screen"/>
  <link rel="stylesheet" href="css/sidebar.css" type="text/css" media="screen"/>
  <script src="jquery.js"></script>
  <script src="jquery-jvectormap-2.0.3.min.js"></script>
  <script src="jquery-jvectormap-world-mill.js"></script>
  <script src="tags/rock.js"></script>
  <script src="tags/metal.js"></script>
  <script src="tags/jazz.js"></script>
  <script src="tags/blues.js"></script>
  <script src="tags/indie.js"></script>
  <script src="tags/classic.js"></script>
  <script src="tags/electro.js"></script>
  <script src="tags/rap.js"></script>
  <script src="tags/pop.js"></script>
  <script src="tags/80s.js"></script>
  <script src="tags/alternative.js"></script>
  <script src="tags/dance.js"></script>
  <script src="tags/british.js"></script>
  <script src="tags/punk.js"></script>
  <script src="tags/reggae.js"></script>
  <script src="tags/rnb.js"></script>
  <script src="tags/singer-songwriter.js"></script>
  <script src="api_extract/topartists.js"></script>
  <script src="api_extract/countries.js"></script>
  <script src="sidebar.js"></script>
  <script src="jquery.canvasjs.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>
  <!--Creating the left navigation bar containing country data-->
	<div id="mySidenav" class="sidenav">
	<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
	
  <!--Artists overview-->
	<div class="header"></div>
	<div class="error"></div>
	<div class="overview">
		<table class="toptable">
			<tr><th></th><th>Top Artists</th><th><span style="font-size:16px;cursor:pointer" class="sidenave" onclick="openNavBubble()">&nbsp;<u>Show Top Tags</u></span></th><th></th></tr>
			<tr><td></td><td></td><td></td><td></td><td></td></tr>
			<tr><td>1.</td><td class="img0"></td><td class="topa0"></td><td class="topt0"></td><td class="s0"></td></tr>
			<tr><td>2.</td><td class="img1"></td><td class="topa1"></td><td class="topt1"></td><td class="s1"></td></tr>
			<tr><td>3.</td><td class="img2"></td><td class="topa2"></td><td class="topt2"></td><td class="s2"></td></tr>
			<tr><td>4.</td><td class="img3"></td><td class="topa3"></td><td class="topt3"></td><td class="s3"></td></tr>
			<tr><td>5.</td><td class="img4"></td><td class="topa4"></td><td class="topt4"></td><td class="s4"></td></tr>
		</table>
    <!--Initializing the div containing the donut diagram -->
	<div id="tagDonut" style="height: 250px; width: 500px; z-index: 8000; margin-bottom: 55px;"></div>
	</div>
	</div>

	<!--Initializing the div for the Bubble chart-->
	<div id="bubble" class="sidenavbubble">
	<div class="headerbubble">Top Tags of Top Artists</div>
			<a href="javascript:void(0)" class="closebtn" onclick="closeNavBubble()">&times;</a>

		<svg width="900" height="900" font-family="sans-serif" font-size="10" text-anchor="middle" class="bubbleFrame"></svg>
	</div>

	<div class = "fullscreen" id="world-map"></div>

  <!--Creating the right sidebar containing heatmap options -->
  <div id="Sidenav" class="sidenav_right">

    <h3 style="margin-left: 5px;color: lightgrey">Heatmap Options</h3>
    <a href="javascript:void(0)" class="closebtn" onclick="closeNavRight()">&times;</a>
      <button class="button" value="red" style="background: linear-gradient(to right, #fee5d9,#fcae91,#fb6a4a,#cb181d)"> Red</button>
      <button class="button" value="blue" style="background: linear-gradient(to right, #f2f0f7,#cbc9e2,#9e9ac8,#6a51a3)">Blue</button>
      <button class="button" value=green style="background: linear-gradient(to right, #edf8e9,#bae4b3,#74c476,#238b45)">Green</button>
      <button class="button" value=sunrise style="background:  linear-gradient(to right, #ffffb2, #fecc5c, #fd8d3c,#e31a1c)">Sunrise</button>
      <!--<button class="button" value=purple style="background:  linear-gradient(to right, #edf8fb,#b3cde3,#8c96c6,#88419d)">Purple</button>
      <button class="button" value=green2 style="background:  linear-gradient(to right, #edf8fb,#b2e2e2,#66c2a4,#238b45)">green2</button>
      <button class="button" value=bluegreen style="background:  linear-gradient(to right, #ffffcc,#a1dab4,#41b6c4,#225ea8)">bluegreen</button>-->

    <form>
      <select id = "tags" class = "tags">
        <option id = "rock" selected>Rock</option> 
        <option id = "metal">Metal</option> 
        <option id = "jazz">Jazz</option> 
        <option id = "blues">Blues</option> 
        <option id = "indie">Indie</option> 
        <option id = "electro">Electro</option> 
        <option id = "classic">Classic</option>
        <option id = "rap">Rap</option>    
        <option id = "pop">Pop</option>  
        <option id = "80s">Eigthies</option>       
        <option id = "alternative">Alternative</option>       
        <option id = "dance">Dance</option>       
        <option id = "british">British</option>       
        <option id = "punk">Punk</option>       
        <option id = "reggae">Reggae</option>       
        <option id = "rnb">RnB</option>       
        <option id = "singer-songwriter">SingerSongwriter</option>       
      </select>
    </form>

<!--Radio Buttons for the two normalization functions -->
    <form>
      <fieldset id = "normalize" style="border:none; color: lightgrey; margin-top: 20px">
        <input type="radio"  name="functions" id="Linear" value="linear" checked>
        <label for="Linear">Linear</label>
        <input type="radio"  name="functions" id="Polynomial" value="polynomial">
        <label for="Polynomial">Polynomial</label>
      </fieldset>
    </form>
  </div>

  <!--Create Button for opening the right Navigation Bar -->
  <div class = "navbar">
    <span class = "navbar" style="font-size:40px;cursor:pointer;z-index: 10000" onclick="openNav()">&#9776; Menu</span>
  </div>

	<script>
    //Initial Tag
    var tag = rock;
    //Color Hex Codes for the Heatmap
    var blue = ['#f2f0f7','#cbc9e2','#9e9ac8','#6a51a3']
    var red = ['#fee5d9','#fcae91','#fb6a4a','#cb181d']
    var green = ['#edf8e9','#bae4b3','#74c476','#238b45']
    var sunrise = ['#ffffb2', '#fecc5c', '#fd8d3c','#e31a1c']
    //var purple = ['#edf8fb','#b3cde3','#8c96c6','#88419d']
    //var green2 = ['#edf8fb','#b2e2e2','#66c2a4','#238b45']
    //var bluegreen = ['#ffffcc','#a1dab4','#41b6c4','#225ea8']

    var my_json;
    var dict;
    var chart
    var name;
    var ccode;

  //Function to initalize the Vector Map
	$(function(){
		$('#world-map').vectorMap({
			map: 'world_mill',
			series: {
				regions: [{
					values: rock, //Dataset for the Countries
					scale: blue, //Colorcodes
					normalizeFunction: 'linear' //Normalization function for the colorcodes
				}]
			},

			//Upon Hovering over a country, show Percentage for the selected Tag / Error message when no data is available
			onRegionTipShow: function(e, el, code){
        if (topartistiscountry[code]){
		    	el.html(el.html()+' ('+ eval(tag)[code].toFixed(2)+ '% ' + 'of the most popular music is tagged ' + $("#tags").val() + ')');
        }
        else{
          el.html("No data available for " + el.html());
        }
			},


      //Upon clicking on a country
			onRegionClick: function(e, code) {
				ccode = code;

        /*Initialize Navbar after clicking on a country
				At first, everything is initialized empty, because some 
        countries have no data.*/

        document.getElementById("mySidenav").style.width = "40%";
    			$(document).ready(function(){
    				$(".error").text(" ")
            		$(".header").text("");
            		$(".topa0").text("");
            		$(".topa1").text("");
            		$(".topa2").text("");
            		$(".topa3").text("");
            		$(".topa4").text("");
            		$(".img0").html("");
            		$(".img1").html("");
            		$(".img2").html("");
            		$(".img3").html("");
            		$(".img4").html("");
            		$(".s0").html("");
            		$(".s1").html("");
            		$(".s2").html("");
            		$(".s3").html("");
            		$(".s4").html("");

              //Initialize the CanvasJS Donut Chart
              chart = new CanvasJS.Chart("tagDonut", {
              backgroundColor:"transparent",

              title: {
                text: "Toptags (relative)"
              },
              animationEnabled: true,
              theme: "theme2",
              data: [
              {
                type: "doughnut",
                indexLabelFontFamily: "Garamond",
                indexLabelFontSize: 20,
                startAngle: 0,
                indexLabelFontColor: "dimgrey",
                indexLabelLineColor: "darkgrey",
                toolTipContent: "{indexLabel}," + " {y}%",

                dataPoints: []
              }
              ]
              });

            //Exists the CountryCode?
            if (topartistiscountry[code])
    				{	
              $(".header").text(countries[code]);

              $.each(topartistiscountry[code], function(key, value){
                $(".topa"+key).text(value["artist"])
              });

              $.each(topartistiscountry[code], function(key, value){
                $(".img"+key).html("<a href="+value["url"]+" target='_blank'><img src="+value["img"]+"  height=80 width=80/></a>");
              });

              $.each(topartistiscountry[code], function(key, value){
                $(".s" +key).html("("+value["listeners"]+")");
              });

              //Extract Tag Data for the respective Country
              arr = jQuery.grep(my_json.toptags, function(i, v) {
              if(i.name == countries[code])
              return(i, v)
              });

              dict = [];

              /*Normally, we want to represent the top 10 tags.
              But some Countries only have one topartist and therefore do not reach 10 Tags.
              So we have to include a Minimum calculation, if such a country is clicked.*/
              var min = Math.min(arr[0].tags.length, 10)

              for(i = 0; i < min; i++) { 
                 dict.push(arr[0].tags[i]);
              }

              //Calculate Maximum for percentage calculation.
              var sum = 0;
              $.each(dict, function(key, value){            
                sum += parseFloat(Object.values(value)[0].toFixed(2));
              });

              //Empty the chart data
              chart.options.data[0].dataPoints = [];

              /*Fill it with the newly retrieved data. The percentages differ here, because the tags are represented 
              relatively to each other and we only represent 10. */
              $.each(dict, function(key, value){            
                chart.options.data[0].dataPoints.push({y: (parseFloat(Object.values(value)[0])/sum*100).toFixed(2), indexLabel: Object.keys(value)[0]}
              )});

              chart.render()
    				}

    				else
    				{
    					//$(".header").text(countries[code]);
    					$(".error").text("No data for "+countries[code]);
              chart.destroy()
    				}
    			})
			;}
		});
	});

  //Load data as a variable
	$.getJSON("results.json", function(json) {
	    my_json = json;
	    
	});

  //open bubble window and show bubble chart
	function openNavBubble(){
		
		document.getElementById("bubble").style.width = "60%";

    //select svg element and get attributs as d3 object
		var svg = d3.select("svg"),
		width = +svg.attr("width"),
    height = +svg.attr("height");
		var format = d3.format(",d");
		var color = d3.scaleOrdinal(d3.schemeCategory20c);

		var pack = d3.pack()
    	.size([width, height])
    	.padding(1.5);
		
    //get csv with data und save in d.values
    d3.csv("api_extract/topTagsArtistsCountries/"+ccode+".csv", function(d){
  	
  		d.value = +d.value;
  		if (d.value) return d;
		},

			function(error, classes) {
  			if (error) throw error;

        //define root element for tree hierarchy
  			var root = d3.hierarchy({children: classes})
      		.sum(function(d) { return d.value; })
      		
          //get last value and save in values, seperated by "."
      		.each(function(d) {
        		if (id = d.data.id) {
        			var id, i = id.lastIndexOf(".");
        			d.id = id;
        			d.package = id.slice(0, i);
        			d.class = id.slice(i + 1);
        		}
      		});
    //define all nodes by selecting all leaves from svg/csv
		node = svg.selectAll(".node")
    	.data(pack(root).leaves())
      //define <g> element for circle
    	.enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

    //create circle with id, radius and color
  	node.append("circle")
     	.attr("id", function(d) { return d.id; })
     	.attr("r", function(d) { return d.r; })
     	.style("fill", function(d) { return color(d.package); });

    //define text element for tag names. by seperating the string in csv
  	node.append("text")
		  .selectAll("tspan")
		  .data(function(d) { return d.class.split(/(?=[A-Z][^A-Z])/g); })
		  .enter().append("tspan")
		  .attr("x", 0)
		  .attr("y", function(d, i, nodes) { return 13 + (i - nodes.length / 2 - 0.5) * 10; })
		  .text(function(d) { return d; });

    //mouse over show artist name
		node.append("title")
		  .text(function(d) { 
		
    var artist = d.id.split(".")

    
		return artist[1] + ": " + format(d.value); });

		});
	}
	

    //Set Map data to the selected Tag
    $("#tags").change(function() {
        tag = $(this).val().toLowerCase()
        var mapObject = $('#world-map').vectorMap('get', 'mapObject');
        var values = mapObject.series.regions[0]
        values.setValues(eval(tag));
        var valuesPrev = $.map(eval(tag), function(value){return value});
        //Min/Max values have to be set manually for correct color coding
        values.params.min = Math.min.apply(null, valuesPrev);
        values.params.max = Math.max.apply(null, valuesPrev);
        values.setValues(eval(tag));
        
      });

    //Set the normalization function upong clicking the radio button
    $("#normalize").change(function() {
        value = $('input[name="functions"]:checked').val();
        var mapObject = $('#world-map').vectorMap('get', 'mapObject');
        var values = mapObject.series.regions[0]
        values.setNormalizeFunction(value.toString());
        var valuesPrev = $.map(eval(tag), function(value){return value});
        values.params.min = Math.min.apply(null, valuesPrev);
        values.params.max = Math.max.apply(null, valuesPrev);
        values.setValues(eval(tag));
      });

    //Set Color Grading for the Heatmap
    $("button").click(function(){
      var mapObject = $('#world-map').vectorMap('get', 'mapObject');
      var values = mapObject.series.regions[0];
      values.setScale(eval($(this).val()))
      var valuesPrev = $.map(eval(tag), function(value){return value});
      values.params.min = Math.min.apply(null, valuesPrev);
      values.params.max = Math.max.apply(null, valuesPrev);
      values.setValues(eval(tag));
    });

	function closeNav() {
    document.getElementById("mySidenav").style.width = "0";
    document.getElementById("bubble").style.width = "0";
    node.remove();
	}

	function closeNavBubble() {
    document.getElementById("bubble").style.width = "0";
    node.remove();
	}

</script>
</body>
</html>